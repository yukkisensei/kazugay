name: ubuntu setup

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - name: Setup user yuu
        run: |
          PASS="lt4c2025"   # pass cố định
          sudo useradd -m -s /bin/bash yuu
          echo "yuu:$PASS" | sudo chpasswd
          echo "CI_USER=yuu" >> $GITHUB_ENV
          echo "CI_PASS=$PASS" >> $GITHUB_ENV

      - name: Install packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            git curl wget unzip build-essential \
            python3 python3-pip cmake ninja-build \
            kitty tightvncserver ccache \
            lxde

          # Brave
          sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" \
            | sudo tee /etc/apt/sources.list.d/brave-browser-release.list >/dev/null
          sudo apt-get update -qq
          sudo apt-get install -y -qq brave-browser

          # Discord
          wget -q -O discord.deb "https://discord.com/api/download?platform=linux&format=deb"
          sudo apt-get install -y -qq ./discord.deb || sudo apt-get install -f -y -qq
          rm -f discord.deb

      - name: Setup Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=ci-${{ github.run_id }}
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      - name: Configure VNC autostart (LXDE + apps)
        run: |
          USER=yuu
          HOME=/home/$USER
          sudo -u $USER mkdir -p $HOME/.vnc
          cat <<EOF | sudo -u $USER tee $HOME/.vnc/xstartup
          #!/bin/sh
          xrdb $HOME/.Xresources
          startlxde &
          kitty &
          brave-browser &
          discord &
          EOF
          sudo chmod +x $HOME/.vnc/xstartup

      - name: Start VNC server
        run: |
          USER=yuu
          HOME=/home/$USER
          sudo -u $USER mkdir -p $HOME/.vnc
          echo $CI_PASS | vncpasswd -f | sudo -u $USER tee $HOME/.vnc/passwd > /dev/null
          sudo chown $USER:$USER $HOME/.vnc/passwd
          chmod 600 $HOME/.vnc/passwd
          sudo -u $USER tightvncserver -geometry 1280x720 -depth 24 -rfbauth $HOME/.vnc/passwd
          echo "==== CONNECT INFO ===="
          echo "Tailscale IP: $TS_IP"
          echo "Port: 5901"
          echo "User: $USER"
          echo "Password: $CI_PASS"
