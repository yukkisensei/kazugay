name: Build CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 3600

    steps:
      - name: Update dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget unzip build-essential software-properties-common \
            cmake pkg-config python3 python3-pip gnupg \
            libwayland-dev wayland-protocols \
            libxkbcommon-dev libseat-dev \
            libdrm-dev libgles2-mesa-dev \
            libpixman-1-dev libvulkan-dev \
            libinput-dev libxcb1-dev libxcb-composite0-dev \
            libxcb-xfixes0-dev libxcb-render0-dev \
            libxcb-icccm4-dev libxcb-image0-dev \
            libxcb-util-dev libxcb-ewmh-dev \
            libxcb-present-dev libxcb-damage0-dev \
            libxcb-randr0-dev libxcb-xinput-dev \
            libxcb-xinerama0-dev libxcb-xkb-dev \
            libpugixml-dev hwdata \
            xwayland dbus-x11 openssl swaybg waybar xterm firefox

      - name: Setup user
        run: |
          PASS=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9' | head -c16)
          sudo useradd -m -s /bin/bash kazugay
          echo "kazugay:$PASS" | sudo chpasswd
          sudo usermod -aG sudo kazugay
          echo "CI_USER=kazugay" >> $GITHUB_ENV
          echo "CI_PASS=$PASS" >> $GITHUB_ENV

      - name: Install compiler (Clang 18 + GCC 13 libstdc++)
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y g++-13
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 60
          sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang-18 60
          sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-18 60
          clang-18 --version
          g++ --version

      - name: Upgrade build system
        run: |
          sudo apt-get remove -y meson || true
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install meson ninja
          meson --version
          ninja --version

      - name: Compile dependency hyprwayland-scanner
        run: |
          git clone https://github.com/hyprwm/hyprwayland-scanner.git
          cd hyprwayland-scanner
          cmake -B build -DCMAKE_CXX_STANDARD=20
          cmake --build build -j$(nproc)
          sudo cmake --install build

      - name: Compile dependency hyprutils
        run: |
          git clone https://github.com/hyprwm/hyprutils.git
          cd hyprutils
          cmake -B build -DCMAKE_CXX_STANDARD=20
          cmake --build build -j$(nproc)
          sudo cmake --install build

      - name: Compile dependency libdisplay-info
        run: |
          git clone https://gitlab.freedesktop.org/emersion/libdisplay-info.git
          cd libdisplay-info
          meson setup build
          ninja -C build
          sudo ninja -C build install

      - name: Compile dependency aquamarine
        run: |
          git clone https://github.com/hyprwm/aquamarine.git
          cd aquamarine
          cmake -B build -DCMAKE_CXX_STANDARD=20
          cmake --build build -j$(nproc)
          sudo cmake --install build

      - name: Compile project Hyprland
        run: |
          git clone --recursive https://github.com/hyprwm/Hyprland
          cd Hyprland
          meson setup build
          ninja -C build
          sudo ninja -C build install

      - name: Compile project WayVNC
        run: |
          git clone https://github.com/any1/wayvnc.git
          cd wayvnc
          meson setup build
          ninja -C build
          sudo ninja -C build install

      - name: Configure environment
        run: |
          USER=kazugay
          HOME=/home/$USER
          sudo -u $USER mkdir -p $HOME/.config/hypr

          echo "IyBNaW5pbWFsIGNvbmZpZwpleGVjID0gc3dheWJnIC1jICIjMmUzNDQwIgoKZXhlYyA9IHdheWJhcgpleGVjID0geHRlcm0KZXhlYyA9IGZpcmVmb3gKbW9uaXRvcj0scHJlZmVycmVkLGF1dG8sYXV0bwpnZW5lcmFsIHsKICAgIGdhcHNfaW49NQogICAgZ2Fwc19vdXQ9MjAKICAgIGJvcmRlcl9zaXplPTIKICAgIGNvbC5hY3RpdmVfYm9yZGVyPTB4ZmY1ZTgxYWMKICAgIGNvbC5pbmFjdGl2ZV9ib3JkZXI9MHhmZjNiNDI1MgpfCn0=" \
          | base64 -d | sudo -u $USER tee /home/$USER/.config/hypr/hyprland.conf

          sudo chown $USER:$USER /home/$USER/.config/hypr/hyprland.conf

      - name: Setup service
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=ci-${{ github.run_id }}

      - name: Start service
        run: |
          TS_IP=$(tailscale ip -4)
          PASS=$CI_PASS
          USER=kazugay

          echo "===================="
          echo "Address: $TS_IP"
          echo "Username: $USER"
          echo "Password: $PASS"
          echo "Port: 5900"
          echo "===================="

          # Start Hyprland
          sudo -u $USER Hyprland &

          # Start WayVNC with password
          echo $PASS > /tmp/vncpass
          chmod 600 /tmp/vncpass
          sudo -u $USER wayvnc 0.0.0.0 5900 --passwordfile /tmp/vncpass &

          # Keep alive
          while true; do
            echo "[$(date)] Service alive"
            sleep 300
          done
