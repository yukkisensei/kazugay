name: ubuntu-rdp-gaming

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Setup gaming user
        run: |
          PASS="lt4c2025"
          sudo useradd -m -s /bin/bash yuu
          echo "yuu:$PASS" | sudo chpasswd
          sudo usermod -aG audio,video,input,plugdev yuu
          echo "CI_USER=yuu" >> $GITHUB_ENV
          echo "CI_PASS=$PASS" >> $GITHUB_ENV

      - name: System performance tuning for gaming
        run: |
          echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2>/dev/null || true
          sudo sysctl -w vm.swappiness=10 || true
          sudo sysctl -w vm.vfs_cache_pressure=50 || true
          sudo sysctl -w kernel.sched_migration_cost_ns=5000000 || true
          sudo sysctl -w kernel.sched_autogroup_enabled=0 || true
          sudo sysctl -w net.core.rmem_max=16777216 || true
          sudo sysctl -w net.core.wmem_max=16777216 || true
          sudo sysctl -w net.ipv4.tcp_fastopen=3 || true
          sudo sysctl -w net.ipv4.tcp_low_latency=1 || true

      - name: Install graphics drivers and libraries
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --no-install-recommends \
            mesa-vulkan-drivers mesa-utils \
            libgl1-mesa-dri \
            vulkan-tools vulkan-validationlayers \
            libvulkan1 libvulkan-dev \
            vainfo libva2 libva-drm2 libva-x11-2 \
            libglu1-mesa libegl-mesa0 \
            xserver-xorg-video-all
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install desktop environment minimal
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --no-install-recommends \
            lxde-core xrdp openbox pcmanfm lxterminal \
            pulseaudio pavucontrol alsa-utils \
            xfonts-base fonts-liberation \
            x11-xserver-utils dbus-x11 xserver-xorg-core
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install gaming platforms and tools
        run: |
          sudo apt-get update -qq
          sudo dpkg --add-architecture i386
          sudo apt-get update -qq
          wget -q -O steam.deb "http://media.steampowered.com/client/installer/steam.deb"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq ./steam.deb || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y -qq
          rm -f steam.deb
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --install-recommends \
            wine64 wine32 winetricks \
            libwine libwine:i386
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            lutris python3-pil python3-yaml
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            gamemode libgamemode0 libgamemodeauto0
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            mangohud goverlay
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            joystick jstest-gtk xboxdrv
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            git curl wget unzip build-essential \
            python3 python3-pip cmake ninja-build \
            ccache kitty
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install browsers
        run: |
          sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" | sudo tee /etc/apt/sources.list.d/brave-browser-release.list >/dev/null
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq brave-browser
          wget -q -O discord.deb "https://discord.com/api/download?platform=linux&format=deb"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq ./discord.deb || sudo apt-get install -f -y -qq
          rm -f discord.deb
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Fix GUI apps disable GPU
        run: |
          sudo mount -o remount,size=2G /dev/shm || true
          sudo mkdir -p /usr/local/bin
          sudo bash -c 'cat > /usr/local/bin/discord-fixed' <<'EOF'
          #!/bin/bash
          /usr/share/discord/Discord \
            --disable-gpu \
            --disable-software-rasterizer \
            --disable-dev-shm-usage \
            --no-sandbox \
            --disable-gpu-compositing \
            --disable-accelerated-2d-canvas \
            "$@"
          EOF
          sudo chmod +x /usr/local/bin/discord-fixed
          sudo bash -c 'cat > /usr/local/bin/brave-fixed' <<'EOF'
          #!/bin/bash
          /usr/bin/brave-browser \
            --disable-gpu \
            --disable-software-rasterizer \
            --disable-dev-shm-usage \
            --no-sandbox \
            --disable-gpu-compositing \
            --disable-accelerated-2d-canvas \
            "$@"
          EOF
          sudo chmod +x /usr/local/bin/brave-fixed
          sudo mkdir -p /home/yuu/.local/share/applications
          sudo cp /usr/share/applications/discord.desktop /home/yuu/.local/share/applications/ || true
          sudo sed -i 's|Exec=/usr/share/discord/Discord|Exec=/usr/local/bin/discord-fixed|g' /home/yuu/.local/share/applications/discord.desktop || true
          sudo cp /usr/share/applications/brave-browser.desktop /home/yuu/.local/share/applications/ || true
          sudo sed -i 's|Exec=brave-browser-stable|Exec=/usr/local/bin/brave-fixed|g' /home/yuu/.local/share/applications/brave-browser.desktop || true
          sudo sed -i 's|Exec=/usr/bin/brave-browser|Exec=/usr/local/bin/brave-fixed|g' /home/yuu/.local/share/applications/brave-browser.desktop || true
          sudo chown -R yuu:yuu /home/yuu/.local || true
          echo "Discord and Brave configured"
          echo "Shared memory remounted"

      - name: Configure GameMode
        run: |
          sudo mkdir -p /etc/gamemode
          sudo bash -c 'cat > /etc/gamemode/gamemode.ini' <<'EOF'
          [general]
          renice=10
          ioprio=0
          inhibit_screensaver=1
          [gpu]
          apply_gpu_optimisations=accept-responsibility
          gpu_device=0
          amd_performance_level=high
          [custom]
          start=notify-send "GameMode started"
          end=notify-send "GameMode ended"
          EOF
          sudo systemctl enable gamemoded 2>/dev/null || true
          sudo systemctl start gamemoded 2>/dev/null || true

      - name: Configure MangoHud
        run: |
          sudo mkdir -p /home/yuu/.config/MangoHud
          sudo bash -c 'cat > /home/yuu/.config/MangoHud/MangoHud.conf' <<'EOF'
          fps
          frametime
          cpu_temp
          gpu_temp
          ram
          vram
          position=top-left
          font_size=24
          background_alpha=0.5
          EOF
          sudo chown -R yuu:yuu /home/yuu/.config/MangoHud

      - name: Optimize RDP for gaming
        run: |
          sudo bash -c 'cat > /etc/xrdp/xrdp.ini' <<'EOF'
          [Globals]
          ini_version=1
          fork=true
          port=3389
          tcp_nodelay=true
          tcp_keepalive=true
          security_layer=negotiate
          crypt_level=high
          max_bpp=32
          xserverbpp=32
          use_fastpath=both
          autorun=
          bitmap_compression=false
          bulk_compression=false
          channel.rdpsnd=true
          channel.rdpdr=true
          channel.drdynvc=true
          channel.cliprdr=true
          [xrdp1]
          name=sesman-Xvnc
          lib=libvnc.so
          username=ask
          password=ask
          ip=127.0.0.1
          port=-1
          EOF
          sudo bash -c 'cat > /etc/xrdp/sesman.ini' <<'EOF'
          [Globals]
          ListenPort=3350
          EnableUserWindowManager=true
          UserWindowManager=startlxde
          DefaultWindowManager=startlxde
          [Security]
          AllowRootLogin=false
          MaxLoginRetry=3
          [Sessions]
          X11DisplayOffset=10
          MaxSessions=10
          KillDisconnected=false
          DisconnectedTimeLimit=0
          Policy=Default
          EOF

      - name: Configure desktop for gaming
        run: |
          sudo mkdir -p /home/yuu/.config/openbox
          sudo bash -c 'cat > /home/yuu/.config/openbox/lxde-rc.xml' <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <openbox_config xmlns="http://openbox.org/3.4/rc">
            <theme>
              <name>Clearlooks</name>
              <animateIconify>no</animateIconify>
            </theme>
            <desktops>
              <number>1</number>
            </desktops>
            <resistance>
              <strength>0</strength>
              <screen_edge_strength>0</screen_edge_strength>
            </resistance>
          </openbox_config>
          EOF
          sudo mkdir -p /home/yuu/.config/lxsession/LXDE
          sudo bash -c 'cat > /home/yuu/.config/lxsession/LXDE/autostart' <<'EOF'
          @lxpanel --profile LXDE
          @pcmanfm --desktop --profile LXDE
          @/usr/bin/pulseaudio --start
          EOF
          sudo mkdir -p /home/yuu/.config/pulse
          sudo bash -c 'cat > /home/yuu/.config/pulse/daemon.conf' <<'EOF'
          default-sample-rate = 48000
          alternate-sample-rate = 44100
          default-fragments = 2
          default-fragment-size-msec = 5
          high-priority = yes
          nice-level = -11
          realtime-scheduling = yes
          realtime-priority = 9
          resample-method = speex-float-1
          EOF
          echo "startlxde" | sudo tee /home/yuu/.xsession
          sudo chown -R yuu:yuu /home/yuu/.config
          sudo chown yuu:yuu /home/yuu/.xsession

      - name: Set custom wallpaper
        env:
          WALLPAPER_URL: ${{ secrets.WALLPAPER_URL }}
        run: |
          if [ -n "$WALLPAPER_URL" ]; then
            sudo mkdir -p /usr/share/backgrounds
            sudo wget -q -O /usr/share/backgrounds/gaming-wallpaper.jpg "$WALLPAPER_URL" || sudo wget -q -O /usr/share/backgrounds/gaming-wallpaper.png "$WALLPAPER_URL" || true
            WALLPAPER_FILE=$(ls /usr/share/backgrounds/gaming-wallpaper.* 2>/dev/null | head -1)
            if [ -f "$WALLPAPER_FILE" ]; then
              sudo mkdir -p /home/yuu/.config/pcmanfm/LXDE
              sudo bash -c "cat > /home/yuu/.config/pcmanfm/LXDE/desktop-items-0.conf" << EOF
          [*]
          wallpaper_mode=stretch
          wallpaper_common=1
          wallpaper=$WALLPAPER_FILE
          desktop_bg=#000000
          desktop_fg=#ffffff
          desktop_shadow=#000000
          show_wm_menu=0
          EOF
              sudo chown -R yuu:yuu /home/yuu/.config/pcmanfm
            fi
          fi

      - name: Setup Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=gaming-${{ github.run_id }}
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      - name: Start RDP service
        run: |
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo systemctl status xrdp --no-pager || true

      - name: Verify gaming setup
        run: |
          glxinfo | grep "OpenGL renderer" || echo "GLX not available"
          vulkaninfo --summary 2>/dev/null | grep "GPU" || echo "Vulkan info not available"
          which steam && echo "Steam installed" || echo "Steam missing"
          which wine && echo "Wine installed" || echo "Wine missing"
          which lutris && echo "Lutris installed" || echo "Lutris missing"
          which gamemoded && echo "GameMode installed" || echo "GameMode missing"
          which mangohud && echo "MangoHud installed" || echo "MangoHud missing"

      - name: Keep alive - Gaming Session
        run: |
          echo "╔════════════════════════════════════════════╗"
          echo "║   🎮 GAMING SESSION ACTIVE 🎮             ║"
          echo "╠════════════════════════════════════════════╣"
          echo "║ Tailscale IP: $TS_IP"
          echo "║ RDP Port:     3389"
          echo "║ Username:     $CI_USER"
          echo "║ Password:     $CI_PASS"
          echo "╠════════════════════════════════════════════╣"
          echo "║ Gaming Tools Installed:                   ║"
          echo "║ • Steam (Linux & Windows games)           ║"
          echo "║ • Wine/Proton (Windows compatibility)     ║"
          echo "║ • Lutris (Game manager)                   ║"
          echo "║ • GameMode (Performance boost)            ║"
          echo "║ • MangoHud (FPS overlay - F12)            ║"
          echo "║ • Discord & Brave Browser                 ║"
          echo "╠════════════════════════════════════════════╣"
          echo "║ Performance Optimizations:                ║"
          echo "║ ✓ CPU Performance Mode                    ║"
          echo "║ ✓ Low Latency RDP (32-bit color)         ║"
          echo "║ ✓ PulseAudio Low Latency                  ║"
          echo "║ ✓ Vulkan & OpenGL Drivers                 ║"
          echo "║ ✓ Network Optimized                       ║"
          echo "╚════════════════════════════════════════════╝"
          while true; do sleep 300; done
