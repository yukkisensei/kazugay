name: “Configure runner environment (Ubuntu)”

on: workflow_dispatch:

jobs: prepare-environment: name: Prepare Ubuntu runner (fast, reliable) runs-on: ubuntu-latest env: PYTHON_VERSION: “3.12.10” USERNAME: “yuu” PASSWORD: “lt4c@2025” steps: - name: Run as root setup script shell: bash run: | set -euo pipefail

      # 1) Fast removal of common unwanted packages (non-interactive, purge config)
      sudo apt-get update -qq
      sudo DEBIAN_FRONTEND=noninteractive apt-get purge -y \
        firefox* chromium-browser chromium google-chrome-stable \
        code code-insiders visual-studio-code* unityhub* || true
      sudo apt-get autoremove -y --purge || true
      sudo apt-get clean || true

      # Remove snap packages quickly (ignore errors)
      if command -v snap >/dev/null 2>&1; then
        snaps=$(snap list --all | awk 'NR>1 {print $1}' || true)
        for s in $snaps; do
          sudo snap remove --purge "$s" || true
        done
        sudo snap remove --purge snapd || true
      fi

      # 2) Install Google Chrome (stable) and set as default
      curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/google-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
      sudo apt-get update -qq
      sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends google-chrome-stable

      if command -v update-alternatives >/dev/null 2>&1; then
        sudo update-alternatives --install /usr/bin/x-www-browser x-www-browser /usr/bin/google-chrome-stable 200
        sudo update-alternatives --set x-www-browser /usr/bin/google-chrome-stable || true
      fi
      if command -v xdg-settings >/dev/null 2>&1; then
        xdg-settings set default-web-browser google-chrome.desktop || true
      fi

      # 3) Install Discord (deb) quickly
      tmpd=$(mktemp -d)
      discord_deb="$tmpd/discord.deb"
      curl -fsSL -o "$discord_deb" "https://discord.com/api/download?platform=linux&format=deb"
      sudo dpkg -i "$discord_deb" || sudo apt-get install -y -f
      rm -rf "$tmpd"

      # 4) Remove user-installed Python versions quickly (keep system-critical files if present)
      sudo rm -rf /opt/python /usr/local/lib/python* /usr/local/bin/python* /usr/local/bin/pip* || true
      sudo rm -rf /home/runner/.pyenv /home/runner/.local/share/virtualenvs || true
      sudo DEBIAN_FRONTEND=noninteractive apt-get purge -y "python3.*" "python.*" || true
      sudo apt-get autoremove -y --purge || true

      echo "Pre-install cleanup completed."

  - name: Setup Python 3.12.10 (adds to PATH)
    uses: actions/setup-python@v5
    with:
      python-version: 3.12.10

  - name: Verify python installation and PATH
    shell: bash
    run: |
      set -euo pipefail
      python3 --version
      which python3
      echo "PATH=$PATH"

  - name: Create user yuu with specified password
    shell: bash
    run: |
      set -euo pipefail
      if id -u "${USERNAME}" >/dev/null 2>&1; then
        sudo usermod -s /bin/bash "${USERNAME}"
      else
        sudo useradd -m -s /bin/bash "${USERNAME}"
      fi
      echo "${USERNAME}:${PASSWORD}" | sudo chpasswd

  - name: Install Tailscale and connect using secret
    shell: bash
    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
    run: |
      set -euo pipefail
      curl -fsSL https://tailscale.com/install.sh | sudo sh
      sudo systemctl enable --now tailscaled
      sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --accept-routes || sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}"

  - name: Final checks
    shell: bash
    run: |
      set -euo pipefail
      dpkg -l google-chrome-stable || true
      dpkg -l discord || true
      python3 --version || true
      tailscale status || true
      xdg-settings get default-web-browser || update-alternatives --query x-www-browser || true

  - name: Summary output
    run: |
      echo "environment-ready=true" >> $GITHUB_OUTPUT
